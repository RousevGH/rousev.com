<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>I bought the whole domain</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

:root {
  --accent: #5965ff;
  --accent-soft: #8a95ff;
  --accent-red: #c71561;
  --bg-light-top: #f6f7ff;
  --bg-light-bottom: #dadced;
  --bg-dark-top: #050713;
  --bg-dark-bottom: #101320;
  --text-light: #11121a;
  --text-dark: #f4f5ff;
  --radius: 18px;
}

/* GLOBAL + SCROLLBARS */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Inter', system-ui, sans-serif;
}

html {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) transparent;
}
::-webkit-scrollbar {
  width: 7px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--accent), var(--accent-soft));
  border-radius: 999px;
}

/* BACKGROUND */
body {
  min-height: 100vh;
  padding-top: 70px;
  background:
    radial-gradient(circle at 0 0, rgba(255,255,255,0.9) 0, transparent 55%),
    radial-gradient(circle at 100% 0, rgba(255,230,250,0.9) 0, transparent 55%),
    linear-gradient(to bottom, var(--bg-light-top), var(--bg-light-bottom));
  color: var(--text-light);
  -webkit-font-smoothing: antialiased;
  transition: background .3s, color .3s;
}
body.dark {
  background:
    radial-gradient(circle at 0 0, rgba(89,101,255,0.4) 0, transparent 60%),
    radial-gradient(circle at 100% 0, rgba(220,60,120,0.4) 0, transparent 65%),
    linear-gradient(to bottom, var(--bg-dark-top), var(--bg-dark-bottom));
  color: var(--text-dark);
}

/* HEADER */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 18px;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  background: rgba(255,255,255,0.94);
  border-bottom: 1px solid rgba(10,10,40,0.12);
  z-index: 50;
  transition: transform .26s ease, background .26s ease, border-color .26s ease;
  will-change: transform;
}
body.dark header {
  background: rgba(7,9,18,0.96);
  border-bottom-color: rgba(255,255,255,0.18);
}
header.hidden {
  transform: translateY(-100%);
}

.header-title {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: -0.03em;
}

/* ICONS */
.icon-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.icon-btn {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(20,20,35,0.15);
  color: #111;
  cursor: pointer;
  transition: .22s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}
body.dark .icon-btn {
  background: rgba(12,15,26,0.94);
  border-color: rgba(255,255,255,0.18);
  color: var(--text-dark);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
.icon-btn svg {
  width: 19px;
  height: 19px;
  fill: currentColor;
}
.icon-btn:hover {
  color: var(--accent);
  border-color: var(--accent);
  transform: scale(1.08) translateY(-1px);
  box-shadow: 0 10px 24px rgba(89,107,255,0.5);
}

/* SORT CONTROLS */
.sort-wrap {
  position: relative;
}
.sort-button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,16,40,0.14);
  background: rgba(255,255,255,0.95);
  font-size: 13px;
  cursor: pointer;
  transition: .18s ease;
  color: inherit;
}
.sort-button svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}
.sort-button:hover {
  border-color: var(--accent);
  color: var(--accent);
}
body.dark .sort-button {
  background: rgba(12,15,26,0.98);
  border-color: rgba(255,255,255,0.18);
  color: var(--text-dark);
}

.sort-menu {
  position: absolute;
  top: 115%;
  right: 0;
  min-width: 200px;
  border-radius: 14px;
  padding: 4px;
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(15,16,40,0.14);
  box-shadow: 0 16px 40px rgba(0,0,0,0.25);
  display: none;
  z-index: 60;
}
.sort-menu.show { display: block; }
body.dark .sort-menu {
  background: rgba(7,9,18,0.98);
  border-color: rgba(255,255,255,0.18);
  color: var(--text-dark);
}

.sort-option {
  padding: 7px 9px;
  border-radius: 10px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: background .16s ease, color .16s ease;
}
.sort-option svg {
  width: 14px;
  height: 14px;
  opacity: .7;
}
.sort-option:hover {
  background: rgba(89,107,255,0.12);
}
.sort-option.active {
  background: rgba(89,107,255,0.18);
  color: var(--accent);
}
.sort-tag-input {
  width: 100%;
  margin-top: 4px;
  padding: 6px 8px;
  font-size: 12px;
  border-radius: 8px;
  border: 1px solid rgba(15,16,40,0.18);
}
body.dark .sort-tag-input {
  background: rgba(7,9,16,0.96);
  border-color: rgba(255,255,255,0.18);
  color: var(--text-dark);
}

/* LAYOUT */
main {
  max-width: 960px;
  margin: 0 auto;
  padding: 26px 16px 40px;
}

/* POSTS */
.post {
  width: 100%;
  max-width: 820px;
  margin: 0 auto 26px;
  padding: 22px 20px 18px;
  border-radius: var(--radius);
  background: linear-gradient(145deg,
      rgba(255,255,255,0.96) 0%,
      rgba(229,232,249,0.99) 100%);
  box-shadow:
    0 16px 30px rgba(0,0,0,0.18),
    0 0 0 1px rgba(255,255,255,0.8);
  cursor: pointer;
  position: relative;
  transform: translateY(30px) scale(.97);
  opacity: 0;
  transition:
    opacity .5s ease,
    transform .5s cubic-bezier(.16,.72,.2,1),
    box-shadow .25s ease,
    border-color .25s ease,
    background .25s ease;
  will-change: transform;
}
body.dark .post {
  background: linear-gradient(145deg,
      rgba(24,26,38,0.98) 0%,
      rgba(7,9,20,0.99) 100%);
  box-shadow:
    0 18px 40px rgba(0,0,0,0.9),
    0 0 0 1px rgba(255,255,255,0.02);
}
.post.visible {
  opacity: 1;
  transform: translateY(0) scale(1);
}
.post:hover {
  box-shadow: 0 24px 60px rgba(10,10,40,0.4);
}

/* tilt is applied by JS on .post transform */

/* pinned */
.post.pinned {
  border: 2px solid var(--accent);
  box-shadow:
    0 0 26px rgba(120,135,255,0.7),
    0 26px 70px rgba(0,0,0,0.95);
}

/* content */
.post-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 6px;
}
.post-body {
  font-size: 14px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.post-body a {
  color: var(--accent);
  text-decoration: none;
}
.post-body a:hover {
  text-decoration: underline;
}
.post-tags {
  margin-top: 10px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.post-tag {
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: linear-gradient(135deg, var(--accent), var(--accent-soft));
  color: #fff;
  border: 1px solid rgba(255,255,255,0.85);
  box-shadow: 0 6px 14px rgba(89,107,255,0.7);
}
.post-date {
  margin-top: 8px;
  font-size: 12px;
  opacity: .7;
  font-style: italic;
}

/* empty */
.empty {
  text-align: center;
  margin-top: 60px;
  opacity: .65;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 80;
  opacity: 0;
  transition: opacity .24s ease;
}
.modal.show {
  display: flex;
  opacity: 1;
}

.modal-panel {
  max-width: 860px;
  width: calc(100% - 40px);
  border-radius: var(--radius);
  padding: 24px 22px 18px;
  background: linear-gradient(145deg,
      rgba(255,255,255,0.98),
      rgba(236,239,255,0.98));
  box-shadow: 0 26px 80px rgba(0,0,0,0.95);
  transform: translateY(18px) scale(0.95);
  transition: transform .24s ease;
  overflow-y: hidden; /* JS will toggle this if content overflows */
}
body.dark .modal-panel {
  background: linear-gradient(145deg,
      rgba(18,20,36,0.98),
      rgba(7,9,20,0.99));
}
.modal.show .modal-panel {
  transform: translateY(0) scale(1);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.modal-title {
  font-size: 20px;
  font-weight: 600;
}
.modal-close {
  cursor: pointer;
  font-size: 26px;
  opacity: .7;
}
.modal-close:hover { opacity: 1; }
.modal-tags {
  margin-top: 8px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.modal-body {
  margin-top: 12px;
  font-size: 14px;
  line-height: 1.7;
  white-space: pre-wrap;
}
.modal-meta {
  margin-top: 10px;
  font-size: 12px;
  opacity: .7;
}
.modal-panel.small {
  max-width: 360px;
}

/* modal internal scrollbar styled */
.modal-panel::-webkit-scrollbar {
  width: 7px;
}
.modal-panel::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--accent), var(--accent-red));
  border-radius: 999px;
}
.modal-panel::-webkit-scrollbar-track {
  background: transparent;
}

/* RESPONSIVE */
@media (max-width: 768px) {
  header {
    padding: 0 10px;
    height: 64px;
  }
  .header-title {
    font-size: 14px;
  }
  main {
    padding: 22px 10px 32px;
  }
  .post {
    padding: 18px 14px;
  }
  .post-title {
    font-size: 18px;
  }
}
</style>
</head>
<body>

<header id="topBar">
  <div class="header-title">
    I bought the whole domain, I'm going to use the whole domain
  </div>

  <div style="display:flex;align-items:center;gap:12px;">
    <div class="sort-wrap">
      <button class="sort-button" id="sortButton">
        <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3zm4 5h14v2H7zm6 5h8v2h-8z"/></svg>
        <span id="sortLabel">By date</span>
      </button>
      <div class="sort-menu" id="sortMenu">
        <div class="sort-option active" data-sort="date">
          <svg viewBox="0 0 24 24"><path d="M7 11h10v2H7zM5 4h14v2H5zM9 18h6v2H9z"/></svg>
          By date (newest)
        </div>
        <div class="sort-option" data-sort="default">
          <svg viewBox="0 0 24 24"><path d="M4 10h16v2H4z"/></svg>
          Default order
        </div>
        <div class="sort-option" data-sort="random">
          <svg viewBox="0 0 24 24"><path d="M4 4h3l4 7-4 7H4l4-7zM13 4h3l4 7-4 7h-3l4-7z"/></svg>
          Random
        </div>
        <div class="sort-option" data-sort="length-asc" id="lengthSort">
          <svg viewBox="0 0 24 24"><path d="M7 4h2v16H7zM15 10h2v10h-2z"/></svg>
          By length
        </div>
        <div class="sort-option" data-sort="tag">
          <svg viewBox="0 0 24 24"><path d="M5 4h9l6 6-9 9-6-6z"/></svg>
          By tag
        </div>
        <input id="tagInput" class="sort-tag-input" placeholder="tag...">
      </div>
    </div>

    <div class="icon-row">
      <button class="icon-btn" id="discordBtn" title="Discord">
        <!-- cleaner Discord icon -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
  <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
</svg>
      </button>

      <button class="icon-btn" id="mailBtn" title="Email">
        <svg viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 3-8 5-8-5V6l8 5 8-5Z"/></svg>
      </button>

      <button class="icon-btn" id="themeBtn" title="Toggle theme">
        <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.5 0-1-.09-1.5A7.52 7.52 0 0 1 12 3Z"/></svg>
      </button>
    </div>
  </div>
</header>

<main>
  <div id="postList">Loading…</div>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-panel" id="modalPanel">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-close" id="modalClose">×</div>
    </div>
    <div class="modal-tags" id="modalTags"></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-meta" id="modalMeta"></div>
  </div>
</div>

<script>
/* THEME INIT */
const storedTheme = localStorage.getItem('rousev-theme');
if (
  storedTheme === 'dark' ||
  (!storedTheme &&
    window.matchMedia &&
    window.matchMedia('(prefers-color-scheme: dark)').matches)
) {
  document.body.classList.add('dark');
}

/* THEME TOGGLE */
document.getElementById('themeBtn').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  localStorage.setItem(
    'rousev-theme',
    document.body.classList.contains('dark') ? 'dark' : 'light'
  );
});

/* HEADER HIDE */
let lastScroll = 0;
const topBar = document.getElementById('topBar');
window.addEventListener('scroll', () => {
  const y = window.scrollY;
  if (y > lastScroll && y > 80) topBar.classList.add('hidden');
  else topBar.classList.remove('hidden');
  lastScroll = y;
});

/* ICON HANDLERS */
document.getElementById('discordBtn').onclick = () =>
  openInfoModal('Discord', '@brousev on discord');
document.getElementById('mailBtn').onclick = () =>
  openInfoModal('Email', 'contact@rousev.com');

/* MODAL */
const modal = document.getElementById('modal');
const modalPanel = document.getElementById('modalPanel');
const modalTitle = document.getElementById('modalTitle');
const modalTags = document.getElementById('modalTags');
const modalBody = document.getElementById('modalBody');
const modalMeta = document.getElementById('modalMeta');
const modalClose = document.getElementById('modalClose');

function sizeModalToContent() {
  // Let content lay out naturally first
  modalPanel.style.height = 'auto';
  modalPanel.style.maxHeight = 'none';
  modalPanel.style.overflowY = 'hidden';

  requestAnimationFrame(() => {
    const maxH = window.innerHeight * 0.85;
    const contentH = modalPanel.scrollHeight;

    if (contentH <= maxH) {
      modalPanel.style.height = contentH + 'px';
      modalPanel.style.maxHeight = contentH + 'px';
      modalPanel.style.overflowY = 'hidden';
    } else {
      modalPanel.style.height = maxH + 'px';
      modalPanel.style.maxHeight = maxH + 'px';
      modalPanel.style.overflowY = 'auto';
    }
  });
}

function openInfoModal(title, text) {
  modalPanel.classList.add('small');
  modalTitle.textContent = title;
  modalBody.textContent = text;
  modalTags.innerHTML = '';
  modalMeta.textContent = '';
  modal.classList.add('show');
  sizeModalToContent();
}

function openPostModal(title, htmlBody, tags, dateStr) {
  modalPanel.classList.remove('small');
  modalTitle.textContent = title;
  modalBody.innerHTML = htmlBody;
  modalTags.innerHTML = tags
    .map(t => `<span class="post-tag">${t}</span>`)
    .join('');
  modalMeta.textContent = dateStr || '';
  modal.classList.add('show');
  sizeModalToContent();
}

function closeModal() {
  modal.classList.remove('show');
}
modalClose.onclick = closeModal;
modal.addEventListener('click', e => {
  if (e.target === modal) closeModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

/* DATE HELPERS */
function daySuffix(d) {
  if (d > 3 && d < 21) return 'th';
  const r = d % 10;
  if (r === 1) return 'st';
  if (r === 2) return 'nd';
  if (r === 3) return 'rd';
  return 'th';
}
function formatPrettyDate(date) {
  const months = ['January','February','March','April','May','June','July',
                  'August','September','October','November','December'];
  const day = date.getDate();
  return `${day}${daySuffix(day)} May ${date.getFullYear()}`.replace(' May', ` ${months[date.getMonth()]}`);
}

/* BODY PROCESSING */
function processBody(text) {
  const escape = s => {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  };
  text = text.replace(/\[\$\/\/image:(.*?)\/\/\]/g, (m, p) =>
    `<img src="${escape(p.trim())}" style="height:1em;vertical-align:baseline;">`
  );
  text = text.replace(/\[\$\/\/url:(.*?)\/\/\]/g, (m, p) =>
    `<img src="${escape(p.trim())}" style="height:1em;vertical-align:baseline;">`
  );
  text = text.replace(/(https?:\/\/[^\s]+)/g, url => {
    const safe = escape(url);
    return `<a href="${safe}" target="_blank" rel="noopener noreferrer">${safe}</a>`;
  });
  return text;
}

/* PARSING POSTS */
function parsePost(raw, number, pinned) {
  const lines = raw.replace(/\r\n/g, '\n').split('\n');
  const rawTitle = (lines[0] || '').trim();

  const tagMatches = rawTitle.match(/\/\#([^\/]+)\//g);
  const tags = tagMatches ? tagMatches.map(t => t.slice(2, -1).trim()) : [];
  const title = rawTitle.replace(/\/\#[^\/]+\//g, '').trim() || '(untitled)';

  let lastIndex = lines.length - 1;
  while (lastIndex > 0 && !lines[lastIndex].trim()) lastIndex--;
  let dateObj = null, dateDisplay = null;
  const lastLine = lines[lastIndex].trim();
  const dm = lastLine.match(/\/\[(\d{2})\.(\d{2})\.(\d{4})\]\//);
  if (dm) {
    const d = parseInt(dm[1], 10);
    const m = parseInt(dm[2], 10) - 1;
    const y = parseInt(dm[3], 10);
    const candidate = new Date(y, m, d);
    if (!isNaN(candidate.getTime())) {
      dateObj = candidate;
      dateDisplay = formatPrettyDate(candidate);
      lastIndex--;
    }
  }

  const bodyRaw = lines.slice(1, lastIndex + 1).join('\n').trim();
  const bodyHtml = processBody(bodyRaw);
  return { number, pinned, title, tags, bodyRaw, bodyHtml, dateObj, dateDisplay };
}

/* LOAD POSTS */
let allPosts = [];
let currentSort = 'date';
let lengthAscending = true;

const postList = document.getElementById('postList');
const sortButton = document.getElementById('sortButton');
const sortMenu = document.getElementById('sortMenu');
const sortLabel = document.getElementById('sortLabel');
const tagInput = document.getElementById('tagInput');

async function loadPosts() {
  const posts = [];
  let pinnedPost = null;

  try {
    const resPinned = await fetch('./posts/IMPORTANT.txt', { cache: 'no-store' });
    if (resPinned.ok) {
      const txt = await resPinned.text();
      pinnedPost = parsePost(txt, -1, true);
    }
  } catch {}

  let i = 1;
  while (true) {
    try {
      const res = await fetch(`./posts/Thing_${i}.txt`, { cache: 'no-store' });
      if (!res.ok) break;
      const txt = await res.text();
      posts.push(parsePost(txt, i, false));
      i++;
    } catch {
      break;
    }
  }

  if (!posts.length && !pinnedPost) {
    postList.innerHTML = '<div class="empty">no posts</div>';
    return;
  }

  allPosts = [];
  if (pinnedPost) allPosts.push(pinnedPost);
  allPosts.push(...posts);
  renderPosts();
}

/* SORTING UI */
sortButton.addEventListener('click', () => {
  sortMenu.classList.toggle('show');
});
document.addEventListener('click', e => {
  if (!sortMenu.contains(e.target) && e.target !== sortButton) {
    sortMenu.classList.remove('show');
  }
});
document.querySelectorAll('.sort-option').forEach(opt => {
  opt.addEventListener('click', () => {
    const mode = opt.dataset.sort;
    if (mode === 'length-asc') {
      currentSort = lengthAscending ? 'length-asc' : 'length-desc';
      lengthAscending = !lengthAscending;
    } else {
      currentSort = mode;
    }
    document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');
    updateSortLabel();
    sortMenu.classList.remove('show');
    renderPosts();
  });
});
tagInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    currentSort = 'tag';
    document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
    document.querySelector('[data-sort="tag"]').classList.add('active');
    updateSortLabel();
    sortMenu.classList.remove('show');
    renderPosts();
  }
});

function updateSortLabel() {
  const labels = {
    'default': 'Default',
    'date': 'By date',
    'random': 'Random',
    'length-asc': 'Length ↑',
    'length-desc': 'Length ↓',
    'tag': 'By tag'
  };
  sortLabel.textContent = labels[currentSort] || 'By date';
}

/* SORTING + RENDER */
function contentLength(post) {
  return post.bodyRaw.replace(/\s+/g, ' ').trim().length;
}

function sortedPosts() {
  let posts = [...allPosts];
  const pinnedIndex = posts.findIndex(p => p.pinned);
  let pinned = null;
  if (pinnedIndex !== -1) pinned = posts.splice(pinnedIndex, 1)[0];

  if (currentSort === 'default') {
    posts.sort((a, b) => a.number - b.number);
  } else if (currentSort === 'date') {
    posts.sort((a, b) => {
      if (!a.dateObj && !b.dateObj) return a.number - b.number;
      if (!a.dateObj) return 1;
      if (!b.dateObj) return -1;
      return b.dateObj - a.dateObj;
    });
  } else if (currentSort === 'random') {
    posts.sort(() => Math.random() - 0.5);
  } else if (currentSort === 'length-asc' || currentSort === 'length-desc') {
    posts.sort((a, b) => {
      const ca = contentLength(a);
      const cb = contentLength(b);
      return currentSort === 'length-asc' ? ca - cb : cb - ca;
    });
  } else if (currentSort === 'tag') {
    const filter = tagInput.value.trim().toLowerCase();
    if (filter) {
      posts = posts.filter(p =>
        p.tags.some(t => t.toLowerCase().includes(filter))
      );
    }
  }

  if (pinned) posts.unshift(pinned);
  return posts;
}

function setTagFilter(tag) {
  tagInput.value = tag;
  currentSort = 'tag';
  document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
  document.querySelector('[data-sort="tag"]').classList.add('active');
  updateSortLabel();
  renderPosts();
}

function renderPosts() {
  const posts = sortedPosts();
  postList.innerHTML = '';
  if (!posts.length) {
    postList.innerHTML = '<div class="empty">no posts</div>';
    return;
  }

  posts.forEach(p => {
    const card = document.createElement('article');
    card.className = 'post' + (p.pinned ? ' pinned' : '');
    card.innerHTML = `
      <div class="post-title">${p.title}</div>
      <div class="post-body">${p.bodyHtml}</div>
      ${p.tags.length ? `<div class="post-tags">
        ${p.tags.map(t=>`<span class="post-tag" data-tag="${t}">${t}</span>`).join('')}
      </div>` : ''}
      ${p.dateDisplay ? `<div class="post-date">${p.dateDisplay}</div>` : ''}
    `;
    card.addEventListener('click', () =>
      openPostModal(p.title, p.bodyHtml, p.tags, p.dateDisplay)
    );
    postList.appendChild(card);
  });

  // Tag click -> filter
  document.querySelectorAll('.post-tag').forEach(tagEl => {
    tagEl.addEventListener('click', e => {
      e.stopPropagation();
      setTagFilter(tagEl.dataset.tag);
    });
  });

  setupReveal();
  setupTilt();
}

/* REVEAL ON SCROLL */
function setupReveal() {
  const cards = document.querySelectorAll('.post');
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) e.target.classList.add('visible');
      else e.target.classList.remove('visible');
    });
  }, { threshold: .3 });
  cards.forEach(c => io.observe(c));
}

/* TILT */
function setupTilt() {
  document.querySelectorAll('.post').forEach(card => {
    card.onmousemove = e => {
      const r = card.getBoundingClientRect();
      const x = e.clientX - (r.left + r.width / 2);
      const y = e.clientY - (r.top + r.height / 2);
      const rx = (-y / 40);
      const ry = (x / 40);
      card.style.transform = `translateY(0) scale(1.03) rotateX(${rx}deg) rotateY(${ry}deg)`;
    };
    card.onmouseleave = () => {
      card.style.transform = 'translateY(0) scale(1)';
    };
  });
}

/* INIT */
loadPosts();
</script>
</body>
</html>
